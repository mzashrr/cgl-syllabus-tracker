<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSC CGL Syllabus Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-200">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col sm:flex-row justify-between items-center">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl font-bold text-gray-800">SSC CGL Syllabus Tracker</h1>
                <p class="mt-1 text-gray-500">Track your progress and get ready for your exam.</p>
            </div>
            <div id="auth-info" class="mt-4 sm:mt-0 sm:ml-4 text-sm text-gray-400 text-center sm:text-right">
                <span id="user-id-display">Signing in...</span>
            </div>
        </header>

        <!-- Warning message for missing Firebase config -->
        <div id="firebase-warning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 hidden" role="alert">
            <p class="font-bold">Warning</p>
            <p>Firebase is not configured. The tracker will not save your progress. To enable data persistence, please provide your Firebase configuration.</p>
        </div>
        
        <main>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Overall Progress</h2>
                    <span id="progress-text" class="ml-2 text-sm font-medium text-blue-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Subject-wise Progress</h2>
                <canvas id="progressChart" width="700" height="300" role="img" aria-label="A bar chart showing subject-wise completion percentages."></canvas>
            </div>


            <div id="syllabus-container">
                <!-- Syllabus sections will be dynamically populated here -->
            </div>

        </main>
    </div>

    <!-- Firebase CDN imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // This is a placeholder and will be populated by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCtF2HJqJOXgVIlUUQfjoql3O7A2V1KACY",
    authDomain: "cgl-syllabus-tracker.firebaseapp.com",
    projectId: "cgl-syllabus-tracker",
    storageBucket: "cgl-syllabus-tracker.firebasestorage.app",
    messagingSenderId: "734973656710",
    appId: "1:734973656710:web:31abbfed498ae0861c9b07",
    measurementId: "G-W255V6T50J"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

        let db, auth;
        let userId = null;
        let syllabusData = [];
        let unsubscribe = null;
        let firebaseReady = false;

        const authInfoEl = document.getElementById('auth-info');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const syllabusContainerEl = document.getElementById('syllabus-container');
        const progressBarEl = document.getElementById('progress-bar');
        const progressTextEl = document.getElementById('progress-text');
        const progressChartEl = document.getElementById('progressChart');
        const firebaseWarningEl = document.getElementById('firebase-warning');

        // SSC CGL Syllabus topics from search results
        const SSC_CGL_SYLLABUS = [
            {
                subject: 'Quantitative Aptitude',
                topics: [
                    'Number System', 'Percentages', 'Profit & Loss', 'Time & Distance',
                    'Ratio & Proportion', 'Averages', 'Simple & Compound Interest', 'Algebra',
                    'Geometry', 'Trigonometry', 'Mensuration'
                ]
            },
            {
                subject: 'General Intelligence & Reasoning',
                topics: [
                    'Analogy', 'Coding-Decoding', 'Syllogism', 'Venn Diagrams',
                    'Number Series', 'Blood Relations', 'Problem-Solving', 'Figural Classification',
                    'Spatial Orientation'
                ]
            },
            {
                subject: 'English Comprehension',
                topics: [
                    'Reading Comprehension', 'Synonyms & Antonyms', 'Error Spotting', 'Sentence Improvement',
                    'Fill in the Blanks', 'Idioms & Phrases', 'One-Word Substitution', 'Active & Passive Voice'
                ]
            },
            {
                subject: 'General Awareness',
                topics: [
                    'History', 'Geography', 'Polity', 'Economics',
                    'General Science (Physics, Chemistry, Biology)', 'Current Affairs', 'Static GK', 'Indian Culture'
                ]
            }
        ];

        // Initializes Firebase and sets up the listener
        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is missing. The app will run, but progress will not be saved.");
                userIdDisplayEl.textContent = "Error: Firebase config missing.";
                firebaseWarningEl.classList.remove('hidden');
                syllabusData = initializeSyllabusData();
                renderSyllabus();
                updateProgressBar();
                renderSubjectChart();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                firebaseReady = true;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        // Start listening to the data after successful authentication
                        await setupFirestoreListener();
                    } else {
                        // Sign in anonymously if no token is provided
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase auth error:", error);
                            userIdDisplayEl.textContent = "Auth failed. Check console.";
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userIdDisplayEl.textContent = "Error: Firebase init failed.";
            }
        };

        // Sets up a real-time listener for the user's progress data
        const setupFirestoreListener = async () => {
            if (unsubscribe) {
                unsubscribe();
            }

            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/syllabus-tracker/progress`);
            
            try {
                unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        syllabusData = docSnap.data().topics;
                        console.log("Progress data loaded:", syllabusData);
                    } else {
                        console.log("No progress data found. Initializing with empty state.");
                        syllabusData = initializeSyllabusData();
                        saveProgress();
                    }
                    renderSyllabus();
                    updateProgressBar();
                    renderSubjectChart();
                }, (error) => {
                    console.error("Error listening to Firestore document:", error);
                    userIdDisplayEl.textContent = "Error loading data.";
                });
            } catch (error) {
                console.error("Error setting up onSnapshot:", error);
                userIdDisplayEl.textContent = "Error setting up listener.";
            }
        };

        // Initializes the syllabus data with `completed` status for each topic
        const initializeSyllabusData = () => {
            return SSC_CGL_SYLLABUS.map(section => ({
                subject: section.subject,
                topics: section.topics.map(topic => ({
                    name: topic,
                    completed: false
                }))
            }));
        };

        // Saves the current syllabus progress to Firestore
        const saveProgress = async () => {
            if (!userId || !firebaseReady) {
                console.warn("Firebase is not ready. Progress will not be saved.");
                return;
            }

            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/syllabus-tracker/progress`);
            
            try {
                await setDoc(userDocRef, { topics: syllabusData });
                console.log("Progress saved successfully!");
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        };

        // Renders the syllabus UI
        const renderSyllabus = () => {
            syllabusContainerEl.innerHTML = '';
            syllabusData.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'bg-white rounded-xl shadow-lg p-6 mb-6';
                sectionDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">${section.subject}</h3>
                    <ul class="space-y-3">
                        ${section.topics.map((topic, topicIndex) => `
                            <li class="flex items-center">
                                <input type="checkbox" id="${section.subject.replace(/\s/g, '-')}-${topicIndex}" 
                                       data-subject="${section.subject}" data-topic-index="${topicIndex}" 
                                       ${topic.completed ? 'checked' : ''}
                                       class="h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 cursor-pointer">
                                <label for="${section.subject.replace(/\s/g, '-')}-${topicIndex}" class="ml-3 text-gray-700 cursor-pointer">
                                    ${topic.name}
                                </label>
                            </li>
                        `).join('')}
                    </ul>
                `;
                syllabusContainerEl.appendChild(sectionDiv);
            });

            // Add event listeners for the checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        };

        // Handles checkbox changes and updates the syllabus data and Firestore
        const handleCheckboxChange = (event) => {
            const subject = event.target.dataset.subject;
            const topicIndex = parseInt(event.target.dataset.topic-index, 10);
            const isChecked = event.target.checked;

            const section = syllabusData.find(s => s.subject === subject);
            if (section) {
                section.topics[topicIndex].completed = isChecked;
                saveProgress(); // Save to Firestore on every change
            }
        };

        // Updates the progress bar and text
        const updateProgressBar = () => {
            let totalTopics = 0;
            let completedTopics = 0;

            syllabusData.forEach(section => {
                totalTopics += section.topics.length;
                completedTopics += section.topics.filter(topic => topic.completed).length;
            });

            const percentage = totalTopics > 0 ? (completedTopics / totalTopics) * 100 : 0;
            progressBarEl.style.width = `${percentage}%`;
            progressTextEl.textContent = `${Math.round(percentage)}%`;
        };
        
        // Renders the subject-wise progress chart using Canvas
        const renderSubjectChart = () => {
            const canvas = progressChartEl;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous drawing

            const chartData = syllabusData.map(section => {
                const total = section.topics.length;
                const completed = section.topics.filter(topic => topic.completed).length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                return {
                    subject: section.subject,
                    percentage: percentage
                };
            });

            const barWidth = 40;
            const padding = 20;
            const chartHeight = canvas.height - 40;
            const chartWidth = canvas.width - padding * 2;
            const barSpacing = chartWidth / chartData.length;

            ctx.font = '12px Inter';
            ctx.fillStyle = '#4b5563';
            ctx.textAlign = 'center';

            chartData.forEach((data, index) => {
                const barHeight = (data.percentage / 100) * chartHeight;
                const x = padding + index * barSpacing + (barSpacing / 2);
                const y = chartHeight - barHeight;

                // Draw the bar
                ctx.fillStyle = '#6366f1';
                ctx.fillRect(x - barWidth / 2, y, barWidth, barHeight);

                // Draw the label (subject name) below the bar
                ctx.fillStyle = '#4b5563';
                ctx.fillText(data.subject, x, chartHeight + 15);

                // Draw the percentage on top of the bar
                ctx.fillStyle = '#fff';
                ctx.fillText(`${Math.round(data.percentage)}%`, x, y - 5);
            });
        };

        // Initial app load
        window.onload = initFirebase;
    </script>
</body>
</html>

